# Ever2e JVM

JVM reference implementation and trace source for Apple IIe / 65C02 behavior.

## What this repo is for

- Run the JVM Apple IIe emulator from `.emu` machine configs.
- Generate per-step CPU traces.
- Compare behavior against the Python port and MAME traces.
- Experiment with soft-switch, slot ROM, and reset behavior.

## Repo layout

- `src/core/emulator/machine/machine8/Emulator8Coordinator.java`: main runner
- `src/core/cpu/cpu8/Cpu65c02.java`: 65C02 core
- `src/core/memory/memory8/MemoryBusIIe.java`: Apple IIe memory map + soft switches
- `ROMS/`: machine configs and ROM binaries

## Build

```bash
cd /Users/shane/Project/ever2e/jvm_repo
javac -cp out -d out src/core/emulator/machine/Emulator.java \
  src/core/cpu/cpu8/Cpu65c02.java \
  src/core/memory/memory8/MemoryBusIIe.java \
  src/core/emulator/machine/machine8/Emulator8Coordinator.java \
  src/peripherals/test/PatternSlotCard.java
```

## Run

Default machine:

```bash
cd /Users/shane/Project/ever2e/jvm_repo
java -Djava.awt.headless=true -cp out core.emulator.machine.machine8.Emulator8Coordinator
```

Specific `.emu` file:

```bash
java -Djava.awt.headless=true -cp out core.emulator.machine.machine8.Emulator8Coordinator \
  /Users/shane/Project/ever2e/jvm_repo/ROMS/Apple2e.emu
```

## CLI args

- `--steps N`
  - Max CPU steps to execute (required for bounded trace runs).
- `--trace-file <path>`
  - Write CPU trace CSV.
- `--trace-phase pre|post`
  - Snapshot phase for instruction rows.
- `--post`
  - Shortcut for `--trace-phase post`.
- `--trace-start-pc <addr>`
  - Do not emit trace rows until this PC is reached (inclusive), then continue tracing normally.
- `--reset-pflag-value <value>`
  - Override reset-time `P` policy (hex `0x..` or decimal). Bits `0x20` and `0x10` stay asserted.
- `--halt-execution <addr>`
  - Stop execution when PC reaches the address (hex `0x....` or decimal).
- `--paste-file <path>`
  - Queue BASIC source text into the keyboard input queue at startup (same CR conversion as paste).

## Trace output format

When `--trace-file` is used:

- Header:
  - `step,event_type,event,pc,opcode,a,x,y,p,s,mnemonic,mode`
- Reset row:
  - `event_type=event`, `event=RESET`
- Instruction rows:
  - `event_type=instr`, `event=` (empty)

Notes:

- `RESET` is a trace event, not a fetched opcode.
- Trace phase defaults to `pre`.
- Use `--trace-phase post` (or `--post`) for post-step rows.

## Examples

Generate a pre-phase trace:

```bash
java -Djava.awt.headless=true -cp out core.emulator.machine.machine8.Emulator8Coordinator \
  /Users/shane/Project/ever2e/jvm_repo/ROMS/Apple2eMemCheck.emu \
  --steps 5000 --trace-file /tmp/jvm_trace.csv
```

Generate a post-phase trace:

```bash
java -Djava.awt.headless=true -cp out core.emulator.machine.machine8.Emulator8Coordinator \
  /Users/shane/Project/ever2e/jvm_repo/ROMS/Apple2eMemCheck.emu \
  --steps 5000 --trace-file /tmp/jvm_trace_post.csv --trace-phase post
```

Generate a trace that starts only at a target PC:

```bash
java -Djava.awt.headless=true -cp out core.emulator.machine.machine8.Emulator8Coordinator \
  /Users/shane/Project/ever2e/jvm_repo/ROMS/Apple2e.emu \
  --steps 200000 --trace-file /tmp/jvm_trace_basic.csv --trace-phase pre --trace-start-pc 0xE000
```

Run with reset `P` policy and halt point:

```bash
java -Djava.awt.headless=true -cp out core.emulator.machine.machine8.Emulator8Coordinator \
  /Users/shane/Project/ever2e/jvm_repo/ROMS/Apple2eMemCheck.emu \
  --steps 200000 --trace-phase pre --reset-pflag-value 0x36 --halt-execution 0xC70B \
  --trace-file /tmp/jvm_halt_trace.csv
```

Queue a BASIC program file for typed input:

```bash
java -Djava.awt.headless=true -cp out core.emulator.machine.machine8.Emulator8Coordinator \
  /Users/shane/Project/ever2e/jvm_repo/ROMS/Apple2e.emu \
  --steps 200000 --paste-file /Users/shane/Project/ever2e/jvm_repo/samples/VBL_TEST.BAS
```

## Known gaps

- Expansion ROM behavior is still under active parity work.
- Full peripheral fidelity and cycle-accurate parity are incomplete.

